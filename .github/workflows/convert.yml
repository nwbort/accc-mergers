name: Convert DOCX to PDF

on:
  # Run after extract workflow completes
  workflow_run:
    workflows: ["Extract and Commit Merger Data"]
    types:
      - completed
  # Manual trigger
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    # Only run if triggered manually or if extract workflow succeeded
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Find unconverted DOCX files
        id: find-docx
        run: |
          # Find all docx files without matching PDFs
          # Use null delimiter to handle spaces in filenames
          > /tmp/unconverted.txt
          
          while IFS= read -r -d '' docx; do
            pdf="${docx%.docx}.pdf"
            if [ ! -f "$pdf" ]; then
              echo "$docx" >> /tmp/unconverted.txt
            fi
          done < <(find data/raw/matters -name "*.docx" -type f -print0 2>/dev/null)
          
          if [ -s /tmp/unconverted.txt ]; then
            echo "Found unconverted files:"
            cat /tmp/unconverted.txt
            echo "has_unconverted=true" >> $GITHUB_OUTPUT
          else
            echo "No unconverted DOCX files found"
            echo "has_unconverted=false" >> $GITHUB_OUTPUT
          fi

      - name: Install LibreOffice
        if: steps.find-docx.outputs.has_unconverted == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y libreoffice-writer --no-install-recommends

      - name: Convert DOCX to PDF
        if: steps.find-docx.outputs.has_unconverted == 'true'
        run: |
          while IFS= read -r docx; do
            if [ -n "$docx" ]; then
              echo "Converting: $docx"
              dir=$(dirname "$docx")
              libreoffice --headless --convert-to pdf --outdir "$dir" "$docx"
            fi
          done < /tmp/unconverted.txt

      - name: Commit converted PDFs
        if: steps.find-docx.outputs.has_unconverted == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add "data/raw/matters/**/*.pdf"
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Convert DOCX attachments to PDF"
            git push
          fi
